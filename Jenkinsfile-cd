pipeline {
  agent any

  environment {
    DOCKER_IMAGE = 'vinay4729/primevideo-app:latest'
    CONTAINER_NAME = 'primevideo-app'
  }

  stages {
    stage('ðŸ›‘ Stop & Remove Old Container') {
      steps {
        script {
          sh """
            echo "ðŸ›‘ Cleaning up old container and port 3000..."

            # Stop and remove container if it exists
            if docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
              echo "Stopping container $CONTAINER_NAME"
              docker stop $CONTAINER_NAME
            fi

            if docker ps -aq -f name=$CONTAINER_NAME | grep -q .; then
              echo "Removing container $CONTAINER_NAME"
              docker rm $CONTAINER_NAME
            fi

            # Kill any container using port 3000
            docker ps --filter publish=3000 --format '{{.ID}}' | xargs -r docker stop || true
            docker ps -a --filter publish=3000 --format '{{.ID}}' | xargs -r docker rm || true

            # Kill any process (not docker) using port 3000
            if lsof -i :3000 | grep LISTEN; then
              echo "Freeing port 3000 from system process"
              fuser -k 3000/tcp || true
            else
              echo "âœ… Port 3000 is already free."
            fi
          """
        }
      }
    }
  }
}

