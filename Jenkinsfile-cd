pipeline {
  agent any

  environment {
    DOCKER_IMAGE = 'vinay4729/primevideo-app:latest'
    CONTAINER_NAME = 'primevideo-app'
  }
stage('ðŸ›‘ Stop & Remove Old Container') {
  steps {
    script {
      sh """
        # Stop container if it's running
        if docker ps -q -f name=$CONTAINER_NAME | grep -q .; then
          echo "Stopping running container: $CONTAINER_NAME"
          docker stop $CONTAINER_NAME
        fi

        # Remove container if it exists (running or stopped)
        if docker ps -aq -f name=$CONTAINER_NAME | grep -q .; then
          echo "Removing existing container: $CONTAINER_NAME"
          docker rm $CONTAINER_NAME
        fi

        # Free port 3000 if still in use
        if lsof -i :3000 | grep LISTEN; then
          echo "Port 3000 is in use. Releasing..."
          fuser -k 3000/tcp || true
        else
          echo "Port 3000 is free."
        fi
      """
    }
  }
}

